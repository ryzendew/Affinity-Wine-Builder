name: Build Wine 10.10

on:
  push:
    branches:
      - main
      - master
  pull_request:
    types: [opened, synchronize, reopened, closed]
    branches:
      - main
      - master
  merge_group:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    # Skip build if PR was closed without merging
    if: |
      github.event_name == 'push' ||
      (github.event_name == 'pull_request' && github.event.action != 'closed') ||
      (github.event_name == 'pull_request' && github.event.pull_request.merged == true) ||
      github.event_name == 'merge_group' ||
      github.event_name == 'workflow_dispatch'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up build environment
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            gcc \
            g++ \
            make \
            flex \
            bison \
            autoconf \
            automake \
            libtool \
            gettext \
            git \
            wget \
            curl \
            tar \
            xz-utils \
            patch \
            pkg-config \
            ccache \
            xorg-dev \
            libx11-dev \
            libxext-dev \
            libxrender-dev \
            libxrandr-dev \
            libxinerama-dev \
            libxi-dev \
            libxfixes-dev \
            libxcursor-dev \
            libxcomposite-dev \
            libxdamage-dev \
            libxss-dev \
            libxtst-dev \
            libasound2-dev \
            libpulse-dev \
            libdbus-1-dev \
            libfontconfig1-dev \
            libfreetype6-dev \
            libjpeg-dev \
            libpng-dev \
            libtiff-dev \
            liblcms2-dev \
            libxml2-dev \
            libxslt1-dev \
            libgnutls28-dev \
            libsane-dev \
            libv4l-dev \
            libgphoto2-dev \
            libcapi20-dev \
            libcups2-dev \
            libkrb5-dev \
            libldap2-dev \
            libsdl2-dev \
            libusb-1.0-0-dev \
            libudev-dev \
            libunwind-dev \
            libavcodec-dev \
            libavformat-dev \
            libavutil-dev \
            libgstreamer1.0-dev \
            libgstreamer-plugins-base1.0-dev \
            samba-dev \
            ocl-icd-opencl-dev \
            opencl-headers \
            gcc-mingw-w64 \
            libwayland-dev \
            wayland-protocols \
            libpcap-dev \
            libpcsclite-dev \
            libvulkan-dev

      - name: Set up ccache
        uses: actions/cache@v4
        with:
          path: ~/.ccache
          key: ${{ runner.os }}-ccache-wine-10.10-${{ hashFiles('patches/wine-10.10/*.patch', 'Build-Wine-10.10.sh') }}
          restore-keys: |
            ${{ runner.os }}-ccache-wine-10.10-

      - name: Configure ccache
        run: |
          ccache --set-config=max_size=10G
          ccache --set-config=compression=true
          ccache --set-config=compression_level=6
          ccache --set-config=sloppiness=pch_defines,time_macros,include_file_mtime,include_file_ctime
          ccache --set-config=hash_dir=false
          ccache --zero-stats
          ccache --show-stats

      - name: Verify OpenCL headers
        run: |
          if [ ! -f "/usr/include/CL/cl.h" ] && [ ! -f "/usr/local/include/CL/cl.h" ]; then
            echo "❌ ERROR: OpenCL headers not found!"
            exit 1
          fi
          echo "✓ OpenCL headers found"

      - name: Set up ccache for cross-compilers
        run: |
          # Configure ccache to work with MinGW cross-compilers
          # Create wrapper scripts that ccache can use
          mkdir -p ~/ccache-bin
          cat > ~/ccache-bin/i686-w64-mingw32-gcc << 'EOF'
          #!/bin/bash
          exec ccache /usr/bin/i686-w64-mingw32-gcc "$@"
          EOF
          cat > ~/ccache-bin/x86_64-w64-mingw32-gcc << 'EOF'
          #!/bin/bash
          exec ccache /usr/bin/x86_64-w64-mingw32-gcc "$@"
          EOF
          cat > ~/ccache-bin/i686-w64-mingw32-g++ << 'EOF'
          #!/bin/bash
          exec ccache /usr/bin/i686-w64-mingw32-g++ "$@"
          EOF
          cat > ~/ccache-bin/x86_64-w64-mingw32-g++ << 'EOF'
          #!/bin/bash
          exec ccache /usr/bin/x86_64-w64-mingw32-g++ "$@"
          EOF
          chmod +x ~/ccache-bin/*
          # Add to PATH (must be before /usr/bin)
          echo "$HOME/ccache-bin" >> $GITHUB_PATH
          echo "✓ ccache wrappers created for MinGW cross-compilers"

      - name: Set build environment variables
        run: |
          echo "BUILD_THREADS=$(nproc)" >> $GITHUB_ENV
          echo "CFLAGS=-O2 -std=gnu17 -pipe -ffat-lto-objects -Wno-discarded-qualifiers -Wno-format -Wno-maybe-uninitialized -Wno-misleading-indentation" >> $GITHUB_ENV
          echo "CROSSCFLAGS=-O2 -std=gnu17 -pipe -Wno-discarded-qualifiers -Wno-format -Wno-maybe-uninitialized -Wno-misleading-indentation" >> $GITHUB_ENV
          echo "CROSSCXXFLAGS=-O2 -std=gnu17 -pipe -Wno-discarded-qualifiers -Wno-format -Wno-maybe-uninitialized -Wno-misleading-indentation" >> $GITHUB_ENV
          echo "CROSSLDFLAGS=-Wl,-O1" >> $GITHUB_ENV
          echo "INSTALL_PREFIX=${{ github.workspace }}/ElementalWarrior-wine-10.10" >> $GITHUB_ENV
          echo "CC=ccache gcc" >> $GITHUB_ENV
          echo "CXX=ccache g++" >> $GITHUB_ENV

      - name: Make script executable
        run: |
          chmod +x Build-Wine-10.10.sh
          echo "✓ Build-Wine-10.10.sh is executable"

      - name: Build Wine 10.10
        env:
          CC: ccache gcc
          CXX: ccache g++
        run: |
          echo "Running Build-Wine-10.10.sh..."
          ./Build-Wine-10.10.sh || {
            echo "❌ Build failed! Checking for error logs..."
            if [ -f "wine64-build/configure.log" ]; then
              echo "=== Configure log ==="
              cat wine64-build/configure.log
            fi
            if [ -f "wine64-build/wine-build.log" ]; then
              echo "=== Last 100 lines of build log ==="
              tail -100 wine64-build/wine-build.log
            fi
            if [ -f "wine64-build/wine-install.log" ]; then
              echo "=== Last 100 lines of install log ==="
              tail -100 wine64-build/wine-install.log
            fi
            exit 1
          }
          
          echo ""
          echo "=========================================="
          echo "ccache statistics (after build):"
          echo "=========================================="
          ccache -s
          echo ""
          echo "Cache hit rate:"
          ccache -s | grep -E "(cache hit|cache miss|hit rate)" || true

      - name: Verify installation
        run: |
          echo "Verifying installation at: $INSTALL_PREFIX"
          
          if [ ! -d "$INSTALL_PREFIX" ]; then
            echo "❌ ERROR: Installation directory not found at $INSTALL_PREFIX"
            exit 1
          fi
          
          echo "✓ Installation directory exists"
          echo "Installation directory contents:"
          ls -la "$INSTALL_PREFIX" || true
          echo ""
          
          # Verify all required directories exist (bin, include, lib, share)
          REQUIRED_DIRS=("bin" "include" "lib" "share")
          MISSING_DIRS=()
          
          for dir in "${REQUIRED_DIRS[@]}"; do
            if [ -d "$INSTALL_PREFIX/$dir" ]; then
              echo "✓ $dir/ directory found"
              echo "  Contents: $(ls -1 "$INSTALL_PREFIX/$dir" | wc -l) items"
            else
              echo "❌ $dir/ directory MISSING!"
              MISSING_DIRS+=("$dir")
            fi
          done
          
          if [ ${#MISSING_DIRS[@]} -gt 0 ]; then
            echo ""
            echo "❌ ERROR: Missing required directories: ${MISSING_DIRS[*]}"
            exit 1
          fi
          
          echo ""
          echo "✓ All required directories verified (bin, include, lib, share)"
          echo ""
          echo "Directory sizes:"
          du -sh "$INSTALL_PREFIX"/* 2>/dev/null || true

      - name: Verify package exists
        run: |
          PACKAGE_NAME="ElementalWarrior-wine-10.10.tar.xz"
          if [ ! -f "$PACKAGE_NAME" ]; then
            echo "❌ ERROR: Package $PACKAGE_NAME not found!"
            exit 1
          fi
          echo "✓ Package found: $PACKAGE_NAME"
          ls -lh "$PACKAGE_NAME"
          echo ""
          echo "Package size: $(du -h "$PACKAGE_NAME" | cut -f1)"

      - name: Upload build logs (on failure)
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: build-logs
          path: |
            wine64-build/configure.log
            wine64-build/wine-build.log
            wine64-build/wine-install.log
          retention-days: 7

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ElementalWarrior-wine-10.10
          path: ${{ github.workspace }}/ElementalWarrior-wine-10.10.tar.xz
          retention-days: 30

      - name: Build summary
        if: always()
        run: |
          echo "=========================================="
          if [ "${{ job.status }}" == "success" ]; then
            echo "✓ BUILD COMPLETE!"
          else
            echo "❌ BUILD FAILED!"
          fi
          echo "=========================================="
          echo ""
          echo "Artifact: ElementalWarrior-wine-10.10.tar.xz"
          echo "Installation prefix: $INSTALL_PREFIX"
          echo ""

